---
title: "Loris_indicator_taxa_analysis"
output: html_document
---

## Indicator Taxa Analysis

For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

Since my work on the diversity analysis took less time than expected, I will also work on indicator taxa analysis, to fulfill Aim 2 of the final research paper. Due to the indicator species analysis being pretty much already completed, I'm using this file to investigate differential abundance with ANCOM-BC2 instead. I may use this file to also do core microbiome analysis as well, if time permits.

#### Differential abundance with ANCOM-BC2:

Here is my code for the differential abundance analysis. Anything notable about the results will be mentioned directly in the code chunks as blocked out text.

```{r Indicator Taxa Analysis}
library(tidyverse)
library(phyloseq)
library(microbiome)
library(indicspecies)
library(ANCOMBC)

phyloseq = readRDS('../Datasets/phyloseq_taxonomy.rds')

# Aggregating to the genus level
ps_genus_glom = tax_glom(phyloseq, 'Genus')

set.seed(421)
ancombc2_out = ancombc2(data = ps_genus_glom, 
               fix_formula = 'Time_of_Collection_categorical*dose_categorical', 
               p_adj_method = 'BH',
               prv_cut = 0.1)

statistical_table = ancombc2_out$res

#writexl::write_xlsx(statistical_table,'../Results/Tables/Module 14 - ANCOMBC Results.xlsx')

# Filter stats to only include taxa that are differentially abundant between the time points:
taxa_to_plot = statistical_table %>% 
  filter(diff_robust_Time_of_Collection_categorical30_days==T) 

# Alternatively, since the previous method got lots of falses (only 1 paired diff robust collumn returned true):
ancombc2_by_dose <- function(dose_for_ancom) {
  # Subsetting the phyloseq object (like in beta diversity)
  ps_sub <- subset_samples(ps_genus_glom,
                           dose_categorical == dose_for_ancom)
  # Droping taxa with zero counts after the subsetting
  ps_sub <- prune_taxa(taxa_sums(ps_sub) > 0, ps_sub)
  # Run ANCOM-BC2 test
  out <- ancombc2(
    data = ps_sub,
    fix_formula = "Time_of_Collection_categorical",
    p_adj_method = "BH",
    prv_cut = 0.1
  )
  # Extracting the results
  res <- out$res %>%
    mutate(dose = dose_for_ancom)

  return(res)
}

dose_levels = unique(sample_data(ps_genus_glom)$dose_categorical)

all_DA_results = lapply(dose_levels, ancombc2_by_dose) %>%
  bind_rows()

# Plot the log 2 fold changes
# Note: you'll have to figure out how to plot the genera names instead of the
# representative ASV names!
taxa_to_plot %>%
  ggplot(aes(taxon,lfc_Time_of_Collection_categorical30_days)) +
  geom_col() +
  coord_flip()
```
