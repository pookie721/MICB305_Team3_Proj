---
title: "Loris_a_and_b_diversity_analysis"
output: html_document
date: "`r Sys.Date()`"
---

## Alpha and Beta Diversity analysis

For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

As my contribution to the term project for MICB 305, I will conduct the diversity analysis, both alpha and beta. I will format the plots to look publication appropriate, and the final plots I make will probably be the ones used in the manuscript, provided everything goes well. Feel free to let me know if there's anything I need to change, but try not to work on this script at the same time as I am, so we can avoid any issues with conflicting pushes!!

#### Rarefaction Alpha diversity analysis:

Here is my code for the Alpha diversity analysis. Anything notable about the results will be mentioned directly in the code chunks as blocked out text.

```{r Alpha_diversity, fig.height=8, fig.width=7}
library(tidyverse)
library(phyloseq)
library(vegan)
library(ggpubr)

### Loading in the phyloseq object:
phyloseq = readRDS('../Datasets/phyloseq_taxonomy.rds')

### Alpha rarefaction curve:
rarecurve(t(data.frame(phyloseq@otu_table)),
          step=1500)

# This graph produced above is just a means of visually representing the rarefaction deapth in RStudio, as an alpha rarefaction curve was already made earlier. Based on the rarefaction curve, a reasonable sampling deapth would be between 90,000 to 100,000. However, due to the sheer number of samples, its visually hard to see the ideal deapth with this plot. The actual rarefaction deapth was already decided to be 87,521, based on the alpha raferfaction curve generated in qiime2 and the filtered table. This deapth allows us to keep 29 samples from the 10 days category and 27 samples from the 30 days category of the Time_after_collection metadata variable, leaving plenty of samples to work with. This also allows us to retain 4,886,056 (65.26%) features and only discard 24 samples, still leaving us with over â…” of the overall number of samples. When looking at the rarefaction curve, there is also a stagnant plateau at this point, allowing us to justify this rarefaction depth.

### rarefying the data:
ps_rare = phyloseq %>% rarefy_even_depth(sample.size = 87521, rngseed = 420)
table(sample_sums(ps_rare))
# 27 samples were removed because they contained fewer reads than the sample size, and 138 OTUs were removed due to molonger being present in any sample after random sampling. 53 samples remain, which is still plenty for a good analysis.

### Plotting alpha diversity:
set.seed(365)
plot_of_richness = plot_richness(ps_rare, x = 'Time_of_Collection_categorical', 
                  measures = c('Observed','Shannon', 'Chao1'),
                  color = 'Time_of_Collection_categorical')
plot_of_richness

# Pulling the data from the rough plot:
plot_richness_data = plot_of_richness$data
# str(plot_richness_data) 

# Ploting alpha diversity again but nicer:
plot_formatted = plot_richness_data %>% ggplot(aes(Time_of_Collection_categorical,value,fill = Time_of_Collection_categorical)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(height=0,width=0.2) +
  theme_classic(base_size=15) +
  facet_grid(~dose_categorical, scales = 'free_y') +
  facet_wrap(~dose_categorical, scales = 'free_y') +
  ylab('Alpha Diversity') + xlab(NULL) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) +
  labs(fill='Time of Collection post-radiation dose', title = "Shannon a-diversity for 4 radiation doses") +
  theme(legend.position = "bottom")
plot_formatted

# Finding the difference between groups of interest:
comparisons = list( c('10_days','30_days'))

plot_formatted +
  stat_compare_means(comparisons = comparisons, method='wilcox.test', size=5) +
  scale_y_continuous(expand = expansion(mult = c(0, .1)))
# Only with the 0.1 Gy dose is tehre a signifficant difference in alpha diversity, showing that the diversity actually increased after 30 days compared to 10 days. (I may go back and do a diversity plot for faith PD and chao.1 as well.)
```

## Beta-diversity analysis:

Here is my code for the Beta diversity analysis. Anything notable about the results will be mentioned directly in the code chunks as blocked out text.

```{r Beta_diversity}
# Phyloseq object was loaded in earlier and data was also rarefied earlier
### Plotting Beta-diversity:
ps_bray = phyloseq::distance(ps_rare, method = "wunifrac")
View(as.matrix(ps_bray)) # Every pairwise comparison included

# MDS scaling
# set.seed(421)
mds = metaMDS(ps_bray)

# Extract data
mds_data = mds$points %>% as.data.frame %>%
  merge(sample_data(ps_rare), by='row.names', sort=F)
head(mds_data)

# Plot it
plot_beta = mds_data %>%
  ggplot(aes(MDS1,MDS2,color = body.site)) +
  geom_point() +
  stat_ellipse() +
  theme_classic(base_size=18)
plot_beta

metadata = sample_data(ps_rare) %>% data.frame() # to make the next lines easier

# Single variable:
stats_univar = adonis2(ps_bray ~ Time_of_Collection_categorical, data = metadata)

# Two variables to account for the different doses:
stats_multivar = adonis2(ps_bray ~ body.site + dose_categorical, data = metadata, by = 'margin') 

# Combine into a table
stats = bind_rows('Univariate' = stats_univar %>% as.data.frame() %>% 
                    rownames_to_column('Variable'),
                  'Multivariate' = stats_multivar %>% as.data.frame() %>% 
                    rownames_to_column('Variable'),
                  .id = 'Model') # First column is Model, either Uni or Multi

# Add some formatting
stats = stats %>% rename(Pval = `Pr(>F)`) %>%
  filter(!is.na(Pval)) # Remove the irrelevant lines

stats # Looks like body site is significant, even when controlling for host!

# Select two body sites to compare
to_compare = c('gut','tongue')

# List samples that belong to those body sites
samples_to_keep = metadata %>% filter(body.site %in% to_compare) %>% rownames()

# Subset the distance matrix to only include those samples
ps_bray_sub = as.matrix(ps_bray)[samples_to_keep,samples_to_keep] %>% as.dist()

# Run a PERMANOVA on just those two body sites
stats_univar = adonis2(ps_bray_sub ~ body.site,
                       data = metadata %>% filter(body.site %in% to_compare))

stats_univar
```
